# Отладка CSP проблем

## Проблема: Запросы блокируются CSP

Если запросы к API блокируются CSP, выполните следующие шаги:

### 1. Проверьте CSP заголовок в консоли сервера

При запуске `npm run dev` в консоли должны появляться сообщения:
```
[CSP] Установлен CSP заголовок:
[CSP] connect-src: 'self' https://dev-bff.fr0.me https://bff.fr0.me https://fr0.me
```

### 2. Проверьте CSP заголовок в браузере

1. Откройте DevTools (F12)
2. Перейдите на вкладку Network
3. Найдите запрос к HTML странице (обычно первый запрос)
4. Откройте Headers и найдите заголовок `Content-Security-Policy`
5. Проверьте, что в `connect-src` есть нужные домены

### 3. Проверьте ошибки CSP в консоли браузера

В консоли браузера (Console) могут быть ошибки вида:
```
Refused to connect to 'https://dev-bff.fr0.me/api/v1/...' because it violates the following Content Security Policy directive: "connect-src 'self' ..."
```

Если видите такую ошибку, значит домен не добавлен в CSP.

### 4. Проверьте переменные окружения

Убедитесь, что в `.env` файле правильно настроены переменные:

```env
# Если используете VITE_CSP_CONNECT_SRC, домены fr0.me все равно будут добавлены автоматически
VITE_CSP_CONNECT_SRC=https://other-api.com
```

### 5. Перезапустите dev сервер

После изменения переменных окружения или кода плагина:
```bash
# Остановите сервер (Ctrl+C)
# Запустите снова
npm run dev
```

### 6. Очистите кэш браузера

Иногда браузер кэширует старую версию страницы с неправильным CSP:
- Нажмите Ctrl+Shift+R (Windows/Linux) или Cmd+Shift+R (Mac) для жесткой перезагрузки
- Или откройте DevTools → Network → включите "Disable cache"

## Решение проблем

### Проблема: Домен не добавлен в CSP

**Решение:** Домены `fr0.me` добавляются автоматически. Если проблема сохраняется:
1. Проверьте консоль сервера на наличие сообщений CSP
2. Убедитесь, что сервер перезапущен после изменений
3. Добавьте домен явно в `.env`:
   ```env
   VITE_CSP_CONNECT_SRC=https://dev-bff.fr0.me,https://bff.fr0.me,https://fr0.me
   ```

### Проблема: CSP заголовок не устанавливается

**Решение:** 
1. Убедитесь, что плагин добавлен в `vite.config.ts`
2. Проверьте, что запрос идет к HTML странице (не к статическим файлам)
3. Проверьте консоль сервера на наличие ошибок

### Проблема: Nonce не совпадает

**Решение:**
1. Убедитесь, что в `index.html` есть placeholder `{{NONCE}}`
2. Проверьте, что все script теги имеют атрибут `nonce`
3. Перезапустите сервер


